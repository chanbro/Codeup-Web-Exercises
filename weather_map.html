<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Map API</title>
    <!--Bootstrap CSS-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!--Google Fonts-->
    <link href="https://fonts.googleapis.com/css?family=Dosis:400,700|Raleway:400,700,800&display=swap" rel="stylesheet">
    <!--Font Awesome-->
    <script src="https://kit.fontawesome.com/4773d21f04.js" crossorigin="anonymous"></script>
    <!--Custom CSS-->
    <style>

        .header-font {
            font-family: 'Raleway', sans-serif;
            font-weight: bold;
            color: #1969B2;
        }

        .featured-font {
            font-family: 'Dosis', sans-serif;
        }

        .weather-container {
            width: 75vw;

        }
        .custom-card {
            width: 33vw;
            background-color: #4591D6;
            color: white;
            box-shadow: 2px 2px 5px black;
        }

        .custom-navbar {
            background-color: #1969B2;
            color: white;
        }

        .mapbox-container {
            width: 75vw;
            height: 45vh
        }

        .icon {
            width: 50px;
            height: 50px;
        }

        #custom-search-icon {
            width: 25px;
            height: 25px
        }

        .tiny-text {
            font-family: 'Raleway', sans-serif;
            font-size: xx-small;
        }

        #byline {
            width: 75vw;
        }

        #search-bar {
            width: 20vh;
        }

        #umbrella-verdict {
            color: #FDB50D;
        }

        .header-container {
            width: 75vw;
        }

        /* The switch - the box around the slider */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* The slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

    </style>
</head>
<body>

<!--Start Branded Navbar-->
<div class="navbar sticky-top header-font custom-navbar">
        <span>
         <img src="img/rain.gif" width="30" height="30" class="d-inline-block align-top" alt="" id="umbrella-watch">
            <span id="brand-name">
                umbrella watch
            </span>
        </span>
    <span id="umbrella-verdict">
    </span>
    <form class="form-inline">
        <input class="form-control mx-2" id="search-bar" type="search" placeholder="San Antonio, TX" aria-label="Search" value="">
        <button class="btn my-2 my-sm-0" type="button" id="custom-search-btn"><img src="img/search.png" alt="Search Button Icon"  id="custom-search-icon"></button>
    </form>
    <!--End Branded Navbar-->
</div>

<!--Start Main Container-->
<div class="container">
    <div class="header-container d-flex my-3">
        <h3 class="header-font drop-shadow" id="location">san antonio, tx</h3>
        <span class="d-flex flex-row ml-auto">
            <h3 class="header-font pr-2 drop-shadow">°f </h3>
            <label class="switch">
                <input type="checkbox">
                <span class="slider round"></span>
            </label>
            <h3 class="header-font pl-2 drop-shadow"> °c</h3>
            </span>
    </div>
    <!--Start Weather Contents-->
    <div class="d-flex flex-row justify-content-center weather-container featured-font">
        <!--Day at a Glace-->
        <div class="card custom-card text-center">
            <div class="card-body" id="daily-container">
                <img class="icon mx-auto my-0" id="daily-icon" src="img/loading-icon.gif" alt="Daily Weather Icon">
                <h4 class="card-title" id="day"></h4>
                <!--Fetched Data from Dark Sky Start-->
            </div>
        </div>

        <!--Right Now-->
        <div class=" card custom-card text-center">
            <div class="card-body" id="current-container">
                <img class="icon mx-auto my-0" id="current-icon" src="img/loading-icon.gif" alt="Current Weather Icon">
                <h4 class="card-title" id="current">Now</h4>
                <!--Fetched Data from Dark Sky Start-->
            </div>
        </div>

        <!--Later-->
        <div class=" card custom-card text-center">
            <div class="card-body" id="later-container">
                <img class="icon mx-auto my-0" id="later-icon" src="img/loading-icon.gif" alt="Later Weather Icon">
                <h4 class="card-title" id="later">Later</h4>
                <!--Fetched Data from Dark Sky Start-->
            </div>
        </div>

        <!--End Weather Contents-->
    </div>

    <!--Start Mapbox Contents-->
    <div class="mapbox-container mt-2" id='map'>
        <!--End Mapbox Contents-->
    </div>

    <div id="byline">

        <p class="tiny-text text-right">Page Created by Chaney Brown</p>

    </div>

    <!--End Main Container-->
</div>




<!--Bootstrap jQuery-->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<!--jQuery 2.2.4-->
<script src="js/jquery-2.2.4.js"></script>
<!--Bootstrap jQuery-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<!--Mapbox jQuery-->
<script src='https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.css' rel='stylesheet' />
<!--Mapbox Geocoder JS-->
<script src="js/mapbox-geocoder-utils.js"></script>
<!--My API Keys-->
<script src="js/keys.js"></script>
<!--Custom Javascript/jQuery-->
<script>
    /*

    ***WORKFLOW***
    1. Create HTML elements/classes/ids
    2. Create jQuery to display Dark Sky weather on page
    3. Add Bootstrap design/custom css
    4. Add Mapbox API
    5. Geocode marker location
    6. Link marker location to Dark Sky Coordinates
    7. Add search function with click/enter listener
    ***********************************

    ***EXAMPLE REQUEST***
    * Dark Sky
        * "https://api.darksky.net/forecast" "+ darkSkyToken + darkSkyCoordinates
    * Mapbox
        * "https://" + mapboxToken + mapboxCoordinates
    ***********************************

    ***WISH LIST***
    * (Site Branding)
    * (Units Toggle)
        * us - Imperial units (default)
        * si - SI units (celsius)
    * (Location)
        * "latitude"
        * "longitude"
    *(Variable Day of the Week) "daily"
        * "icon"
        * "data"
            * "temperatureHigh"
            * "temperatureLow"
            * "precipProbability"
            * "precipType"
    * "hourly" <--Referencing a property on the same level as "daily"
            * "summary"
    * (Right Now) "currently"
        * "icon"
        * "temperature"
        * "apparentTemperature"
        * "summary"
        * "precipProbability"
        * "precipType"
    ***********************************
    */


    $(function () {

        $.when(
            $.ajax("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkyToken + "/29.4241, -98.4936"))
            .done
            (function(weather) {
                console.log(weather);

                //Dark Sky html location variable
                // let darkSkyCoordinates = '"' + weather.latitude + "," +weather.longitude + '"';

                //Accessing API object to convert their time property to date/time
                const dateObject = new Date(weather.currently.time * 1000);
                console.log(dateObject.toString());

                $('#daily-container').append(dailyWeather());

                function dailyWeather() {
                    return (
                        '<p class="mx-auto my-0" id="high-temperature">' + 'High: ' + weather.daily.data[0].temperatureHigh + '°' +
                        '</p><p class="mx-auto my-0" id="low-temperature">' + 'Low: ' + weather.daily.data[0].temperatureLow + '°' +
                        '</p><p class="mx-auto my-0" id="precipitation">' + 'Precipitation: ' + (weather.daily.data[0].precipProbability * 100) + '%' +
                        '</p><p class="mx-auto my-0" id="day-summary">' +  'Day at a Glance: ' + weather.hourly.summary +
                        '</p>'
                    )
                }

                $('#current-container').append(currentWeather());

                function currentWeather() {
                    return (
                        '<p class="mx-auto my-0" id="current-temperature">' + 'Current Temperature: ' + weather.currently.temperature + '°' +
                        '</p><p class="mx-auto my-0" id="apparentTemperature">' + 'Feels Like: ' + weather.currently.apparentTemperature + '°' +
                        '</p><p class="mx-auto my-0" id="current-precipProbability">' + 'Precipitation: ' + (weather.currently.precipProbability * 100) + '%' +
                        '</p><p class="mx-auto my-0" id="current-summary">' + 'Current Conditions: ' + weather.currently.summary +
                        '</p>'
                    )
                }

                $('#later-container').append(futureWeather());

                function futureWeather() {
                    return (
                        '<p class="mx-auto my-0" id="current-temperature">' + 'Temperature: ' + weather.hourly.data[4].temperature + '°' +
                        '</p><p class="mx-auto my-0" id="apparentTemperature">' + 'Feels Like: ' + weather.hourly.data[4].apparentTemperature + '°' +
                        '</p><p class="mx-auto my-0" id="current-precipProbability">' + 'Precipitation: ' + (weather.hourly.data[4].precipProbability * 100) + '%' +
                        '</p><p class="mx-auto my-0" id="current-summary">' + 'Future Conditions: ' + weather.hourly.data[4].summary +
                        '</p>'
                    )
                }

                $('#day').text(dayOfWeek());

                function dayOfWeek(){
                    let dateInfo = dateObject.toString();
                    let day = dateInfo.substring(0, dateInfo.indexOf(" "));
                    if (day === 'Sun' || day === 'Mon' || day === 'Fri')
                        return day + "day";
                    else if (day === 'Tue')
                        return "Tuesday";
                    else if (day === 'Wed')
                        return "Wednesday";
                    else if (day === 'Thurs')
                        return "Thursday";
                    else if (day === 'Sat')
                        return "Saturday";
                    else
                        return "error"
                }

                const iconDisplay =
                    [
                        {
                            'conditions': 'clear-day',
                            'url': 'img/clear-day.png'
                        }, {
                        'conditions': 'clear-night',
                        'url': 'img/clear-night.png'
                    }, {
                        'conditions': 'rain',
                        'url': 'img/rain.png'
                    }, {
                        'conditions': 'snow',
                        'url': 'img/snow.png'
                    }, {
                        'conditions': 'sleet',
                        'url' : 'img/sleet.png'
                    }, {
                        'conditions': 'wind',
                        'url': 'img/wind.png'
                    }, {
                        'conditions':'fog',
                        'url': 'img/fog.png'
                    }, {
                        'conditions': 'cloudy',
                        'url': 'img/cloudy.png'
                    }, {
                        'conditions': 'partly-cloudy-day',
                        'url': 'img/partly-cloudy-day.png'
                    }, {
                        'conditions': 'partly-cloudy-night',
                        'url': 'img/partly-cloudy-night.png'
                    }

                    ];

                $('#daily-icon').attr('src', dailyIconUrl());

                function dailyIconUrl() {
                    for (let i = 0; i < iconDisplay.length; i++) {
                        if (weather.daily.data[0].icon === iconDisplay[i].conditions)
                            return iconDisplay[i].url
                    }
                }

                $('#current-icon').attr('src', currentIconUrl());

                function currentIconUrl() {
                    for (let i = 0; i < iconDisplay.length; i++) {
                        if (weather.currently.icon === iconDisplay[i].conditions)
                            return iconDisplay[i].url
                    }
                }

                $('#later-icon').attr('src', laterIconUrl());

                function laterIconUrl() {
                    for (let i = 0; i < iconDisplay.length; i++) {
                        if (weather.hourly.data[4].icon === iconDisplay[i].conditions)
                            return iconDisplay[i].url
                    }
                }

                $('#umbrella-watch').attr('src', umbrellaForecast());

                function umbrellaForecast() {
                    for (let i = 0; i < 4; i++) {
                        if (weather.hourly.data[i].icon === "rain" || weather.hourly.data[i].icon === "snow" || weather.hourly.data[i].icon === "sleet")
                            return 'img/umbrella.png';
                        else
                            return 'img/clear-day.png'
                    }
                }

                $('body').css('background-color', changeBG());

                function changeBG() {
                    for (let i = 0; i < 4; i++) {
                        if (weather.hourly.data[i].icon === "rain" || weather.hourly.data[i].icon === "snow" || weather.hourly.data[i].icon === "sleet")
                            return 'gray';
                        else
                            return 'white'
                    }
                }

                $('#umbrella-verdict').text(umbrellaText()).hide().slideDown('slow');


                function umbrellaText() {
                    for (let i = 0; i < 4; i++) {
                        if (weather.hourly.data[i].icon === "rain" || weather.hourly.data[i].icon === "snow" || weather.hourly.data[i].icon === "sleet") {
                            $('#umbrella-verdict').css('color', 'white');
                            $('.drop-shadow').css({
                                'color' : '#FDB50D',
                            });
                            return 'Should I bring an umbrella with me? Yes'}
                        else
                            return 'Should I bring an umbrella with me? No'
                    }
                }

                //attempt to make F/C switch
                $('.switch').click(degreesSwitch());

                function degreesSwitch(){
                    $.ajax("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkyToken + "/29.4241,-98.4936?units=si")
                }

                //Mapbox html location variable
                // let mapboxCoordinates = NEEDS to return as a string of "/longitude,latitude" to append to Mapbox request

                //Apply searchInput to Mapbox and Dark Sky; marker should also move with searchInput



                $("#custom-search-btn").click(
                    function () {
                        let searchInput = $('#search-bar').val();
                        let searchString = searchInput.toLowerCase();
                        $('#location').text(searchString);
                        console.log(searchString);
                        let stringToCoords = function(result) {
                            console.log(result);
                            map.setCenter(result)
                            map.setZoom(15);
                            //Create Draggable Marker
                            let marker = new mapboxgl.Marker({
                                draggable: true,
                                color: "#FDB50D"
                            })
                                .setLngLat(result)
                                .addTo(map);

                            function onDragEnd() {
                                var lngLat = marker.getLngLat();
                                coordinates.style.display = 'block';
                                coordinates.innerHTML =
                                    'Longitude: ' + lngLat.lng + '<br />Latitude: ' + lngLat.lat;
                            }

                            marker.on('dragend', onDragEnd);//add it to the map
                        };

                        let mapboxCoordinates = geocode(searchString, mapboxToken).then(stringToCoords);
                        console.log(mapboxCoordinates);

                        let darkSkyCoordinates = function () {
                            let longitude = mapboxCoordinates[0];
                            let latitude = mapboxCoordinates[1];
                            return latitude + "," + longitude
                        };



                    });




                // Generates map
                mapboxgl.accessToken = mapboxToken;
                let map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v9',
                    zoom: 10,
                    center: [-98.4936, 29.4241],
                });


                //Create Draggable Marker
                let marker = new mapboxgl.Marker({
                    draggable: true,
                    color: "#FDB50D"
                })
                    .setLngLat([-98.4936, 29.4241])
                    .addTo(map);

                function onDragEnd() {
                    var lngLat = marker.getLngLat();
                    coordinates.style.display = 'block';
                    coordinates.innerHTML =
                        'Longitude: ' + lngLat.lng + '<br />Latitude: ' + lngLat.lat;
                }

                marker.on('dragend', onDragEnd);//add it to the map

            });
    });
</script>
<script></script>
</body>
</html>